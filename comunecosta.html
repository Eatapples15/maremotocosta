<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bollettino del Comune - Protezione Civile Basilicata</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        h2 {
            color: #34495e;
            margin-top: 35px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.6em;
        }

        h3 {
            color: #34495e;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .info-card {
            background-color: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .info-card p {
            margin-bottom: 10px;
        }

        .criticity-box {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            margin-top: 10px;
            font-size: 1.1em;
            text-align: center;
        }

        /* Dynamic colors based on Firebase data, if available, otherwise fallback */
        .color-green { background-color: #28a745; }
        .color-yellow { background-color: #ffc107; color: #333; }
        .color-orange { background-color: #fd7e14; }
        .color-red { background-color: #dc3545; }

        .timestamp {
            font-size: 0.9em;
            color: #777;
            text-align: right;
            margin-top: 20px;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .alert-item {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start; /* Align icon to top */
            gap: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        .alert-item.info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .alert-item.warning { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
        .alert-item.danger { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        .alert-item i {
            font-size: 1.8em;
            /* Adjust icon color based on alert type */
        }
        .alert-item.info i { color: #17a2b8; }
        .alert-item.warning i { color: #ffc107; }
        .alert-item.danger i { color: #dc3545; }


        .alert-item strong {
            display: block; /* Ensures title is on its own line */
            margin-bottom: 5px;
            /* Inherits color from parent alert-item */
        }
        .alert-item p {
            margin-bottom: 0;
        }

        .risk-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f8f8;
            border-left: 5px solid #007bff;
            border-radius: 5px;
        }

        .risk-item strong {
            display: block;
            margin-bottom: 5px;
            color: #007bff;
            font-size: 1.1em;
        }
        .risk-guidelines { /* New style for guidelines section */
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        .risk-guidelines h4 {
            color: #555;
            font-size: 1em;
            margin-bottom: 8px;
        }
        .risk-guidelines ul {
            list-style: disc;
            margin-left: 20px;
            margin-bottom: 5px;
            color: #666;
        }
        .risk-guidelines ul li {
            margin-bottom: 3px;
        }


        .punto-mappa-item {
            background-color: #f8fcf8;
            border: 1px solid #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .punto-mappa-item .punto-type {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 5px;
            display: block;
            font-size: 1.1em;
        }

        .punto-mappa-item .punto-name { /* Added for better structure */
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .punto-mappa-item .punto-address {
            margin-bottom: 5px;
            color: #555;
        }

        .punto-mappa-item .punto-coords {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 5px;
        }

        .punto-mappa-item .punto-notes {
            font-style: italic;
            color: #666;
            font-size: 0.95em;
        }

        /* Specific styles for Punti Operativi (Cancelli) */
        .punto-mappa-item.operative-point {
            background-color: #ffe6e6; /* Light red/pink for operational points */
            border: 1px solid #ffcccc;
        }
        .punto-mappa-item.operative-point .punto-type {
            color: #dc3545; /* Red for operative type */
        }


        .no-data {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            margin-top: 15px;
        }

        /* Specific styles for Punti Operativi (Cancelli) */
        .punto-mappa-item.gate-red {
            background-color: #ffe6e6; /* Light red */
            border: 1px solid #ffcccc;
        }
        .punto-mappa-item.gate-orange {
            background-color: #fff4e6; /* Light orange */
            border: 1px solid #ffeacc;
        }
        .punto-mappa-item.gate-red .punto-type {
            color: #dc3545; /* Red */
        }
        .punto-mappa-item.gate-orange .punto-type {
            color: #fd7e14; /* Orange */
        }

        /* New styles for procedure sections */
        .procedure-risk-section {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .procedure-risk-section h3 {
            color: #007bff; /* Primary blue for risk title */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .procedure-entity-item {
            background-color: #e9f5ff; /* Lighter blue for entity blocks */
            border: 1px solid #cce5ff;
            padding: 12px 18px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .procedure-entity-item strong {
            display: block;
            font-size: 1.15em;
            color: #0056b3;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #a8daff;
        }
        .procedure-entity-item ul {
            list-style: decimal; /* Numbered list for procedures */
            margin-left: 20px;
            margin-top: 5px;
            color: #333;
        }
        .procedure-entity-item ul li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .role-selector {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .role-selector label {
            font-weight: bold;
            color: #495057;
            margin-right: 10px;
            font-size: 1.1em;
        }

        .role-selector button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .role-selector button:hover {
            background-color: #0056b3;
        }

        .role-selector button.active {
            background-color: #28a745;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }

        .back-button {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .back-button:hover {
            background-color: #0056b3;
        }

        /* Custom Div Icons for Leaflet */
        .leaflet-div-icon {
            background: none;
            border: none;
        }

        .custom-area-icon {
            background-color: #28a745; /* Green for emergency areas */
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .custom-gate-icon {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.7);
        }

        .custom-gate-icon.red {
            background-color: #dc3545; /* Red for Cancello Rosso */
        }
        .custom-gate-icon.orange {
            background-color: #fd7e14; /* Orange for Cancello Arancione */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 id="comune-name">Caricamento Comune...</h1>

        <div class="role-selector">
            <label for="select-role"><i class="fas fa-user-shield"></i> Stai visualizzando come:</label>
            <button id="role-cittadino" data-role="cittadino">Cittadino</button>
            <button id="role-comune" data-role="comune">Comune</button>
            <button id="role-ente" data-role="ente">Ente</button>
        </div>

        <div id="criticity-info-card" class="info-card" data-roles="cittadino,comune,ente">
            <h2><i class="fas fa-exclamation-triangle mr-2"></i>Criticità Attuale</h2>
            <div id="criticity-display" class="criticity-box">N/D</div>
            <p id="criticity-description" class="mt-2"></p>
        </div>

        <div id="risks-info-card" class="info-card" data-roles="cittadino,comune,ente">
            <h2><i class="fas fa-shield-alt mr-2"></i>Informazioni sui Rischi</h2>
            <p id="rischio-generale-display"></p>
            <div id="rischi-specifici-list">
            </div>
            <p class="no-data" id="no-risks-message" style="display: none;">Nessuna informazione sui rischi disponibile
                per questo comune.</p>
        </div>

        <div id="emergency-areas-info-card" class="info-card" data-roles="cittadino,comune,ente">
            <h2><i class="fas fa-map-marker-alt mr-2"></i>Aree di Emergenza / Punti Operativi</h2>
            <p id="map-points-intro-text">Di seguito le aree di emergenza (punti di raccolta, assistenza) sul territorio comunale.</p>
            <div id="punti-mappa-display">
            </div>
            <p class="no-data" id="no-punti-mappa-message" style="display: none;">Nessun punto mappa disponibile per
                questo comune.</p>
            <div id="map"></div>
        </div>

        <div id="contacts-info-card" class="info-card" data-roles="comune,ente">
            <h2><i class="fas fa-phone-alt mr-2"></i>Contatti di Emergenza</h2>
            <div id="contatti-emergenza-display">
            </div>
            <p class="no-data" id="no-contatti-message" style="display: none;">Nessun contatto di emergenza definito
                per questo comune.</p>
        </div>

        <div id="procedures-info-card" class="info-card" data-roles="comune,ente"> <h2><i class="fas fa-clipboard-list mr-2"></i>Procedure Operative per Operatori ed Enti</h2>
            <p>Queste procedure sono associate a rischi specifici e delineano i compiti per i vari enti responsabili durante un'emergenza.</p>
            <div id="procedure-operative-display">
            </div>
            <p class="no-data" id="no-procedure-message" style="display: none;">Nessuna procedura operativa definita
                per questo comune.</p>
        </div>

        <div id="alerts-info-card" class="info-card" data-roles="cittadino,comune,ente">
            <h2><i class="fas fa-bell mr-2"></i>Allerte Attuali</h2>
            <div id="alerts-list">
                </div>
            <p class="no-data" id="no-alerts-message" style="display: none;">Non ci sono allerte attive al momento per
                il comune di <span id="alert-comune-name-placeholder"></span>. Controllare regolarmente per
                aggiornamenti.</p>
        </div>

        <div class="timestamp">
            Dati aggiornati al: <span id="last-updated">Caricamento...</span>
        </div>

        <div class="text-center mt-6">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left mr-2"></i> Torna alla Panoramica Regionale
            </a>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration (still here, but not used for data fetching in this mode)
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // <--- REPLACE WITH YOUR ACTUAL API KEY (or leave as placeholder)
            authDomain: "bollettinoregionale.firebaseapp.com",
            projectId: "bollettinoregionale",
            databaseURL: "https://bollettinoregionale-default-rtdb.europe-west1.firebasedatabase.app/",
            storageBucket: "bollettinoregionale.appspot.com",
            messagingSenderId: "765538370497",
            appId: "1:765538370497:web:9c4f569754c0df01cc2540",
        };

        // Initialize Firebase (even if not used for data, for consistency in future)
        // const app = firebase.initializeApp(firebaseConfig); // Uncomment when Firebase is active
        // const database = firebase.database(); // Uncomment when Firebase is active
        // const comuniRef = database.ref('comuni'); // Uncomment when Firebase is active
        // const coloriRef = database.ref('colori'); // Uncomment when Firebase is active


        // HTML Elements
        const comuneNameElement = document.getElementById('comune-name');
        const criticityDisplay = document.getElementById('criticity-display');
        const criticityDescription = document.getElementById('criticity-description');
        const rischioGeneraleDisplay = document.getElementById('rischio-generale-display');
        const rischiSpecificiList = document.getElementById('rischi-specifici-list');
        const noRisksMessage = document.getElementById('no-risks-message');
        const puntiMappaDisplay = document.getElementById('punti-mappa-display');
        const noPuntiMappaMessage = document.getElementById('no-punti-mappa-message');
        const contattiEmergenzaDisplay = document.getElementById('contatti-emergenza-display');
        const noContattiMessage = document.getElementById('no-contatti-message');
        const procedureOperativeDisplay = document.getElementById('procedure-operative-display');
        const noProcedureMessage = document.getElementById('no-procedure-message');
        const lastUpdatedElement = document.getElementById('last-updated');
        const alertsList = document.getElementById('alerts-list');
        const noAlertsMessage = document.getElementById('no-alerts-message');
        const alertComuneNamePlaceholder = document.getElementById('alert-comune-name-placeholder');
        const mapPointsIntroText = document.getElementById('map-points-intro-text');


        let map = null; // Leaflet map variable
        let currentRole = 'cittadino'; // Default role, will be overridden by URL param

        // Colori e descrizioni di criticità globali (DEVONO ESSERE IDENTICI a index.html)
        const globalColors = {
            "A1": { label: "Verde", hex: "#28a745", description: "di attenzione ordinaria, senza particolari criticità imminenti. Si raccomanda cautela e monitoraggio." },
            "A2": { label: "Giallo", hex: "#ffc107", description: "di moderata attenzione, con possibili criticità locali. Si invita a prestare attenzione e a seguire le indicazioni delle autorità." },
            "A3": { label: "Arancione", hex: "#fd7e14", description: "di attenzione elevata, con criticità significative e potenziale impatto. È consigliabile adottare misure precauzionali e tenersi informati." },
            "A4": { label: "Rosso", hex: "#dc3545", description: "di allerta massima, con grave rischio e necessità di precauzioni immediate. Seguire strettamente le direttive delle autorità e, se necessario, attuare i piani di emergenza." }
        };

        // Funzione di normalizzazione (identica a quella usata in index.html e admin.html)
        function normalizeComuneName(nome) {
            if (!nome) return "";
            return nome.toLowerCase().trim().replace(/\s+/g, ' ').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // Funzione per normalizzare i tipi di rischio per le chiavi (copiata da admin.html)
        function normalizeRiskType(riskName) {
            return riskName.toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        // Funzione per normalizzare il nome dell'ente per le chiavi (copiata da admin.html)
        function normalizeEntityName(entityName) {
            // Updated to also map some common entity names to simpler keys if needed for consistency
            const mappings = {
                "sindaco": "sindaco",
                "ufficio tecnico": "ufficiotecnico",
                "vigili del fuoco": "vigilidelfuoco",
                "polizia locale": "polizialocale",
                "carabinieri": "carabinieri",
                "prefettura": "prefettura", // Aggiunto mapping per "prefettura"
                "capitaneria di porto": "capitaneriadiporto",
                "protezione civile regionale": "protezionecivileregionale",
                "centro operativo comunale (coc)": "coc" // Example for COC
            };
            const normalized = entityName.toLowerCase().replace(/\s+/g, '').normalize("NFD").replace(/[\u0300-\u036f]/g, '');
            return mappings[normalized] || normalized;
        }


        // Funzione per ottenere il parametro dall'URL
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // Funzione per ottenere il nome visualizzato del rischio da quello normalizzato
        function getRiskDisplayNameFromNormalized(normalizedRiskType) {
            // Lista dei rischi predefiniti (deve essere identica a quella in admin.html)
            const predefinedRisks = [
                "Rischio idraulico", "Rischio diga", "Rischio idrogeologico",
                "Rischio incendi", "Rischio Sismico", "Rischio Industriale",
                "Rischio Maremoto", "Rischio neve", "Rischio ambientale"
            ];
            // Trova il rischio originale confrontando la versione normalizzata
            const foundRisk = predefinedRisks.find(risk => normalizeRiskType(risk) === normalizedRiskType);
            // Se trovato, ritorna il nome originale, altrimenti prova a "de-normalizzare" o ritorna il normalizzato
            if (foundRisk) return foundRisk;
            // Fallback for simple de-normalization (e.g., "rischioidraulico" -> "Rischio Idraulico")
            return normalizedRiskType.replace(/([A-Z])/g, ' $1').replace(/^rischio/, 'Rischio ').trim();
        }

        // Funzione per ottenere la descrizione testuale del colore di criticità
        function getColorDescription(criticityCode) {
            return globalColors[criticityCode] ? globalColors[criticityCode].description : 'non definita. Contattare le autorità competenti per maggiori informazioni.';
        }

        function getCriticityColorClass(criticityCode) {
            if (globalColors[criticityCode]) {
                return `color-${globalColors[criticityCode].label.toLowerCase()}`;
            }
            return '';
        }

        // --- Dati GeoJSON per le Aree di Emergenza (per Policoro) ---
        const emergencyAreasRawData = [
            {
                tipologia: "CENTRO DI ASSISTENZA ALLA POPOLAZIONE (C.A.P.1)",
                nome: 'Polifunzionale "Palaercole"',
                ubicazione: "Via Umbria",
                lat: 40.20883394323659, lon: 16.665672863620713,
                note: "Struttura coperta, attrezzata per l'accoglienza prolungata."
            },
            {
                tipologia: "AREA DI ASSISTENZA ALLA POPOLAZIONE (A.P.1)",
                nome: 'Parc. Polifunzionale "Palaercole" - Piazza A. Moro',
                ubicazione: "Via Papa Giovanni Paolo II",
                lat: 40.2083499609406, lon: 16.669912343286097,
                note: "Area aperta adiacente al Palaercole."
            },
            {
                tipologia: "AREA DI ASSISTENZA ALLA POPOLAZIONE (A.P.2)",
                nome: 'Campo Sportivo "R. Periello"',
                ubicazione: "Via San Gottardo",
                lat: 40.202660874879165, lon: 16.670793115504434,
                note: "Area esterna ampia, con possibilità di tende e strutture temporanee."
            },
            {
                tipologia: "AREE DI AMMASSAMENTO",
                nome: "Piazza A. Moro",
                ubicazione: "Via Papa Giovanni Paolo II",
                lat: 40.208777554175555, lon: 16.669838334392445,
                note: "Punto di raccolta e smistamento."
            },
            {
                tipologia: "AREA DI ASSISTENZA ALLA POPOLAZIONE COMPRENSIORALE (A.P.C.)",
                nome: 'Parc. Polifunzionale "Palaercole" - Piazza A. Moro',
                ubicazione: "Via Umbria",
                lat: 40.20860047797445, lon: 16.66815086951912,
                note: "Area strategica per il coordinamento comprensoriale."
            },
            {
                tipologia: "AREA DI ATTESA (A.A.1)",
                nome: 'Parc. Polifunzionale "Palaercole"',
                ubicazione: "Via Umbria",
                lat: 40.20860047797445, lon: 16.66815086951912,
                note: "Punto di attesa temporaneo prima dell'assegnazione ad area di accoglienza."
            },
            {
                tipologia: "AREA DI ATTESA (A.A.2)",
                nome: 'Campo Sportivo "R. Periello"',
                ubicazione: "Via San Gottardo",
                lat: 40.202660874879165, lon: 16.670793115504434,
                note: "Punto di attesa secondario."
            },
            {
                tipologia: "AREA DI ATTESA (A.A.3)",
                nome: 'Parc. "Ex Zuccherificio"',
                ubicazione: "Via Lido",
                lat: 40.20858421660303, lon: 16.685300392249157,
                note: "Ampia area di attesa, facilmente raggiungibile dalla zona litoranea."
            },
            {
                tipologia: "AREA DI ATTESA (A.A.4)",
                nome: "Area Via Lido",
                ubicazione: "Via Lido",
                lat: 40.19755094954803, lon: 16.69994436668819,
                note: "Punto di attesa per la zona sud del litorale."
            },
            {
                tipologia: "AREA DI ATTESA (A.A.5)",
                nome: "Area Via Verdi",
                ubicazione: "Via Verdi",
                lat: 40.17918103598341, lon: 16.678246928970157,
                note: "Punto di attesa per la zona periferica sud-ovest."
            },
            {
                tipologia: "AREA PARCHEGGIO POPOLAZIONE (A.M.1)",
                nome: "Area Archeologica",
                ubicazione: "Via Gonzaga",
                lat: 40.211319791542614, lon: 16.671444679728058,
                note: "Area designata per il parcheggio veicoli durante l'emergenza."
            },
            {
                tipologia: "AREA PARCHEGGIO POPOLAZIONE (A.M.2)",
                nome: "Prolungamento Via Siris",
                ubicazione: "Via Siris",
                lat: 40.19970002378048, lon: 16.6696314217047,
                note: "Area secondaria di parcheggio."
            },
            {
                tipologia: "CENTRO OPERATIVO COMUNALE (C.O.C)",
                nome: "Edificio Comunale",
                ubicazione: "Piazza A. Moro",
                lat: 40.20903805929999, lon: 16.669785800372367,
                note: "Sede principale del coordinamento delle operazioni di emergenza."
            },
            {
                tipologia: "CENTRO COORDINAMENTO D'AMBITO (C.C.A)",
                nome: 'Polifunzionale "Palaercole"',
                ubicazione: "Via Umbria",
                lat: 40.209632452759244, lon: 16.666928244855328,
                note: "Punto di coordinamento per emergenze di più ampio raggio."
            },
        ];

        // --- Dati estratti e rifiniti dai PDF per i Cancelli di Policoro ---
        const gateLocationsRawData = [
            {
                nome: "Cancello Torre Mare 2",
                ubicazione: "C.da Torre Mare 2",
                tipologia: "Cancello per Zona Rossa Maremoto", // Specifico per operatore
                livello_allerta: "Rosso", // Per icona e visualizzazione
                lat: 40.20786, lon: 16.66779, // Coords from PDF for 'Cancello Torre Mare 2'
                note: "Blocco totale del traffico. Consentito solo a mezzi di soccorso autorizzati. Attivo in allerta A3/A4. Accesso alla viabilità di sfollamento dalla costa."
            },
            {
                nome: "Cancello Torre Mare 3",
                ubicazione: "C.da Torre Mare 3",
                tipologia: "Cancello per Zona Rossa Maremoto",
                livello_allerta: "Rosso",
                lat: 40.20658, lon: 16.66619, // Coords from PDF for 'Cancello Torre Mare 3'
                note: "Blocco totale del traffico. Consentito solo a mezzi di soccorso autorizzati. Attivo in allerta A3/A4."
            },
            {
                nome: "Cancello Via Lido",
                ubicazione: "Via Lido (altezza Ex Zuccherificio)",
                tipologia: "Cancello per Zona Arancione/Rossa Maremoto",
                livello_allerta: "Arancione", // Può diventare Rosso in allerta A4
                lat: 40.20877, lon: 16.68533, // Coords from PDF for 'Cancello Via Lido'
                note: "Punto di controllo accesso e informazione alla popolazione. Percorso di evacuazione primario. Attivo in allerta A2/A3/A4."
            },
            {
                nome: "Cancello Santapelagina",
                ubicazione: "C.da Santapelagina",
                tipologia: "Cancello per Zona Arancione Maremoto",
                livello_allerta: "Arancione",
                lat: 40.19830, lon: 16.67493, // Coords from PDF for 'Cancello Santapelagina'
                note: "Punto di controllo traffico e indicazione vie di fuga. Attivo in allerta A2/A3."
            },
            {
                nome: "Cancello Santapelagina 1",
                ubicazione: "C.da Santapelagina 1",
                tipologia: "Cancello per Zona Arancione Maremoto",
                livello_allerta: "Arancione",
                lat: 40.19696, lon: 16.67345, // Coords from PDF for 'Cancello Santapelagina 1'
                note: "Punto di controllo traffico. Attivo in allerta A2/A3."
            },
            {
                nome: "Cancello Santapelagina 2",
                ubicazione: "C.da Santapelagina 2",
                tipologia: "Cancello per Zona Arancione Maremoto",
                livello_allerta: "Arancione",
                lat: 40.19572, lon: 16.67205, // Coords from PDF for 'Cancello Santapelagina 2'
                note: "Punto di controllo traffico. Attivo in allerta A2/A3."
            },
            {
                nome: "Cancello Marinella 1",
                ubicazione: "C.da Marinella 1",
                tipologia: "Cancello per Zona Rossa Maremoto",
                livello_allerta: "Rosso",
                lat: 40.18956, lon: 16.69085, // Coords from PDF for 'Cancello Marinella 1'
                note: "Blocco totale del traffico. Consentito solo a mezzi di soccorso autorizzati. Attivo in allerta A3/A4. Accesso alla viabilità di sfollamento dalla costa sud."
            },
            {
                nome: "Cancello Marinella", // Questo è diverso dal "Marinella 1" sul PDF, che è a 3.20 Km
                ubicazione: "C.da Marinella (generico)",
                tipologia: "Cancello per Zona Rossa Maremoto",
                livello_allerta: "Rosso",
                lat: 40.18700, lon: 16.69200, // Stima basata sulla distanza 3.20Km nel PDF
                note: "Blocco totale del traffico. Attivo in allerta A3/A4."
            },
            // Aggiungiamo i cancelli mancanti dal PDF, dove possibile ricavando le coordinate
            {
                nome: "Cancello Torre Mare 1",
                ubicazione: "C.da Torre Mare 1",
                tipologia: "Cancello per Zona Rossa Maremoto",
                livello_allerta: "Rosso",
                lat: 40.20942, lon: 16.66938, // Coords from PDF for 'Cancello Torre Mare 1'
                note: "Blocco totale del traffico. Attivo in allerta A3/A4."
            },
            {
                nome: "Cancello SS106 Torre Mozza",
                ubicazione: "S.S. 106 - Torre Mozza",
                tipologia: "Cancello per Zona Rossa Maremoto",
                livello_allerta: "Rosso",
                lat: 40.18244, lon: 16.71120, // Coords from PDF
                note: "Blocco totale del traffico. Attivo in allerta A3/A4."
            },
            {
                nome: "Cancello S.P. ex SS407",
                ubicazione: "S.P. ex S.S. 407 (Innesto Via Montegrappa)",
                tipologia: "Cancello per Zona Arancione Maremoto",
                livello_allerta: "Arancione",
                lat: 40.21040, lon: 16.66690, // Coords from PDF
                note: "Punto di controllo traffico e indicazione vie di fuga. Attivo in allerta A2/A3."
            },
            {
                nome: "Cancello S.P. 104 Torre Mozza",
                ubicazione: "S.P. 104 - Torre Mozza",
                tipologia: "Cancello per Zona Arancione Maremoto",
                livello_allerta: "Arancione",
                lat: 40.17950, lon: 16.70900, // Coords from PDF (approx. based on map/context)
                note: "Punto di controllo traffico e indicazione vie di fuga. Attivo in allerta A2/A3."
            }
        ];


        // Dati fittizi per dimostrazione, con inclusione di contatti, procedure e nuova struttura per i cancelli
        // Questi dati sono la parte più importante che tu mi fornirai per ogni comune
        const dummyComuniData = {
            "policoro": {
                "originalName": "Policoro",
                "criticità": "A2", // Esempio: Giallo
                "rischi": {
                    "generale": "Il comune di Policoro presenta rischi legati a eventi idraulici e maremoto, data la sua posizione costiera.",
                    "rischioidraulico": {
                        "alertStatus": "A2", // Giallo
                        "alertMessage": "Possibili esondazioni di corsi d'acqua minori in caso di forti piogge. Evitare zone a ridosso dei corsi d'acqua.",
                        "guidelines": {
                            "before": ["Pulire grondaie e tombini per facilitare il deflusso dell'acqua.", "Non gettare rifiuti nei fiumi o nei canali di scolo per evitare ostruzioni.", "Verificare la stabilità di argini e sponde private se adiacenti a corsi d'acqua."],
                            "during": ["Non avvicinarsi a corsi d'acqua in piena, argini o ponti.", "Non transitare in sottopassi o zone allagate.", "Muoversi solo se strettamente necessario e con la massima prudenza."],
                            "after": ["Seguire le indicazioni delle autorità e dei bollettini ufficiali.", "Verificare danni a strutture e infrastrutture (abitazioni, recinzioni).", "Non bere acqua dal rubinetto se non certificata come potabile dalle autorità."]
                        }
                    },
                    "rischiomaremoto": {
                        "alertStatus": "A1", // Verde, per dimostrazione
                        "alertMessage": "Nessuna allerta maremoto in corso. Monitorare le comunicazioni ufficiali.",
                        "guidelines": {
                            "before": ["Informarsi sui piani di evacuazione costiera e sulle vie di fuga designate.", "Identificare i punti di raccolta elevati e le aree di attesa più vicine.", "Preparare un kit di emergenza con beni di prima necessità (acqua, cibo, farmaci, documenti)."],
                            "during": ["In caso di allerta o percezione di terremoto con epicentro in mare, allontanarsi immediatamente dalla costa e spostarsi verso aree interne e sopraelevate.", "Non tornare indietro per recuperare beni materiali.", "Seguire scrupolosamente le vie di fuga indicate e le direttive delle forze dell'ordine e della Protezione Civile."],
                            "after": ["Attendere il cessato allarme ufficiale prima di rientrare in aree costiere.", "Verificare l'integrità delle strutture abitative e lavorative.", "Collaborare con i soccorritori e le autorità per la gestione dell'emergenza."]
                        }
                    }
                },
                "aree_emergenza": emergencyAreasRawData, // Usa i dati forniti
                "punti_operativi": gateLocationsRawData, // USA I DATI AGGIORNATI DAI PDF
                "contatti_emergenza": [
                    { "ruolo": "Sindaco", "nome": "Enrico Mascia", "contatto1": "0835978111", "contatto2": "sindaco.policoro@comune.it" },
                    { "ruolo": "Responsabile Protezione Civile Comunale", "nome": "Giuseppe Rossi", "contatto1": "3331122334", "contatto2": "protcivile.policoro@comune.it" },
                    { "ruolo": "Comando Carabinieri Policoro", "nome": "Ten. Marco Verdi", "contatto1": "0835972001", "contatto2": "" },
                    { "ruolo": "Vigili del Fuoco Matera", "nome": "Sala Operativa", "contatto1": "0835311222", "contatto2": "" },
                    { "ruolo": "Prefettura Matera", "nome": "Sala Operativa Unificata", "contatto1": "0835348111", "contatto2": "protocollo.prefmt@pec.interno.it" },
                    { "ruolo": "Capitaneria di Porto Taranto (competente per fascia ionica)", "nome": "Ufficio Circondariale Marittimo", "contatto1": "0994711111", "contatto2": "taranto@guardiacostiera.it" }
                ],
                "procedure_operative": {
                    "rischioidraulico": {
                        "sindaco": [
                            "Emettere ordinanza di allerta idraulica e informare la popolazione.",
                            "Attivare il Centro Operativo Comunale (COC) e coordinare tutte le funzioni di supporto.",
                            "Monitorare costantemente i livelli dei corsi d'acqua e l'evoluzione meteorologica.",
                            "Richiedere il supporto delle squadre di volontariato e dei mezzi necessari."
                        ],
                        "ufficiotecnico": [
                            "Verificare la funzionalità delle opere idrauliche e dei sistemi di drenaggio.",
                            "Ispezionare i punti critici a rischio esondazione e frana.",
                            "Preparare mezzi e personale per interventi di ripristino post-evento."
                        ],
                        "vigilidelfuoco": [
                            "Intervenire prontamente per soccorso a persone e beni in aree allagate.",
                            "Effettuare prosciugamenti e rimozione di ostacoli al deflusso delle acque.",
                            "Supportare le operazioni di evacuazione se richieste dal COC.",
                            "Messa in sicurezza di aree a rischio crollo o dissesto idrogeologico."
                        ],
                        "polizialocale": [
                            "Interdire il transito veicolare e pedonale nelle zone allagate o a rischio.",
                            "Regolare il traffico sulle vie alternative e sui percorsi di sicurezza.",
                            "Supportare l'informazione alla popolazione e l'applicazione delle ordinanze comunali.",
                            "Vigilare sul rispetto delle norme di sicurezza nelle aree a rischio."
                        ],
                        "carabinieri": [
                            "Garantire l'ordine pubblico e la sicurezza nelle aree colpite o evacuate.",
                            "Pattugliare le zone a rischio per prevenire sciacallaggi e garantire la protezione dei beni.",
                            "Supportare le operazioni di evacuazione e assistenza alla popolazione, fornendo anche supporto logistico.",
                            "Coordinare con le altre forze dell'ordine e il COC le attività di controllo del territorio."
                        ],
                        "prefettura": [ // Aggiunta Prefettura per rischio idrogeologico
                            "Coordinare gli enti a livello provinciale per interventi di protezione civile.",
                            "Valutare la necessità di dichiarazione dello stato di emergenza provinciale o regionale.",
                            "Fornire supporto e coordinamento alle operazioni di soccorso e assistenza alla popolazione.",
                            "Monitorare la situazione e diffondere le informazioni a livello superiore."
                        ]
                    },
                    "rischiomaremoto": {
                        "sindaco": [
                            "Emettere ordinanza di allerta e/o evacuazione immediata per le zone costiere a rischio tsunami (Zona Rossa/Arancione).",
                            "Attivare il Centro Operativo Comunale (COC) e tutte le funzioni di emergenza, con particolare attenzione alla funzione censimento popolazione e assistenza alla popolazione.",
                            "Coordinare l'apertura e la gestione dei cancelli operativi (Zona Rossa/Arancione) con le forze dell'ordine e la Polizia Locale, garantendo il flusso di evacuazione.",
                            "Assicurare la massima diffusione delle informazioni tramite sirene, megafoni, social media, messaggistica e altoparlanti mobili."
                        ],
                        "polizialocale": [
                            "Attuare il blocco degli accessi e il presidio dei cancelli designati (rossi/arancioni) per le zone a rischio maremoto.",
                            "Pattugliare le aree costiere (Zona Rossa/Arancione) per assicurare l'evacuazione rapida e completa della popolazione.",
                            "Assistere i cittadini lungo le vie di fuga e indirizzarli verso le aree di attesa/ammassamento/emergenza designate.",
                            "Gestire e regolamentare il flusso veicolare lungo i percorsi di evacuazione, prevenendo ingorghi."
                        ],
                        "protezionecivileregionale": [
                            "Fornire supporto tecnico, logistico e di personale al COC comunale (mezzi speciali, moduli abitativi, squadre specializzate per ricerca e soccorso).",
                            "Coordinare l'intervento a livello regionale con altri comuni e enti coinvolti nella gestione dell'emergenza maremoto.",
                            "Monitorare in tempo reale l'onda di maremoto e l'evoluzione della situazione, fornendo aggiornamenti al COC.",
                            "Attivare le Colonne Mobili Regionali e Nazionali se necessario."
                        ],
                        "carabinieri": [
                            "Mantenere l'ordine pubblico e la sicurezza nelle aree evacuate e lungo i percorsi di fuga e nelle aree di attesa/ammassamento.",
                            "Supportare attivamente le operazioni di evacuazione, inclusa la ricerca di eventuali dispersi, anche con l'uso di mezzi speciali (es. imbarcazioni) se necessario.",
                            "Contribuire alla verifica dell'integrità delle infrastrutture critiche post-evento e prevenire atti di sciacallaggio."
                        ],
                        "vigilidelfuoco": [
                            "Intervenire per eventuali soccorsi urgenti a persone in pericolo in aree isolate o danneggiate dalla mareggiata (es. crolli, allagamenti residui).",
                            "Effettuare sopralluoghi rapidi per verificare la stabilità di strutture pericolanti e mettere in sicurezza.",
                            "Supportare le operazioni di ricerca e soccorso con mezzi anfibi o natanti nelle zone costiere colpite, in coordinamento con la Capitaneria di Porto.",
                            "Garantire il supporto tecnico per la riattivazione di servizi essenziali (es. elettricità, gas) in sicurezza."
                        ],
                        "capitaneriadiporto": [
                            "Diramare avvisi di allerta a tutte le imbarcazioni presenti in porto o in mare e coordinare l'eventuale rientro in sicurezza o l'allontanamento dalla costa.",
                            "Monitorare lo stato del mare e le condizioni delle coste dal punto di vista marittimo, fornendo dati aggiornati.",
                            "Supportare l'evacuazione dalla zona portuale e delle aree demaniali marittime, inclusi stabilimenti balneari e strutture turistiche.",
                            "Condurre operazioni di ricerca e soccorso in mare in caso di imbarcazioni in difficoltà o persone disperse."
                        ],
                        "prefettura": [ // Aggiunta Prefettura per rischio maremoto
                            "Attivare il Centro Coordinamento Soccorsi (CCS) e/o il Comitato Provinciale di Protezione Civile.",
                            "Emettere comunicazioni ufficiali e coordinare la risposta provinciale all'emergenza maremoto.",
                            "Disporre l'intervento di ulteriori forze dell'ordine o militari a supporto delle operazioni comunali.",
                            "Valutare la richiesta di riconoscimento dello stato di emergenza di rilievo nazionale."
                        ]
                    }
                },
                "alerts": [
                    { "id": "alert_001_policoro", "type": "Maremoto", "severity": "Moderata", "title": "Allerta di Pre-Allarme Maremoto", "description": "Si raccomanda alla popolazione nelle zone costiere di allontanarsi dalla spiaggia e di spostarsi verso aree interne e sopraelevate. Seguire le indicazioni delle autorità.", "date": "2025-06-16T12:00:00Z" }
                    // Aggiungi qui altre allerte specifiche per Policoro se necessario
                ],
                "lastUpdated": "2025-06-16T13:30:00Z"
            },
            "novasiri": {
                "originalName": "Nova Siri",
                "criticità": "A1",
                "rischi": {
                    "generale": "Nova Siri è esposta a rischi idrogeologici e, in misura minore, a rischio incendi durante i periodi estivi.",
                    "rischioidrogeologico": {
                        "alertStatus": "A2", // Giallo
                        "alertMessage": "Possibili smottamenti in aree collinari. Si raccomanda prudenza.",
                        "guidelines": {
                            "before": ["Monitorare il territorio e segnalare anomalie.", "Evitare costruzioni in zone a rischio geomorfologico."],
                            "during": ["Non avvicinarsi a zone franose o pendii instabili.", "In caso di rumori sospetti o movimenti del terreno, allontanarsi."],
                            "after": ["Attendere verifiche tecniche prima di rientrare nelle abitazioni.", "Segnalare danni alle autorità."]
                        }
                    },
                    "rischioincendi": {
                        "alertStatus": "A1", // Verde
                        "alertMessage": "Basso rischio incendi. Mantenere alta la vigilanza.",
                        "guidelines": {
                            "before": ["Pulire aree verdi intorno alle abitazioni.", "Non accendere fuochi all'aperto, soprattutto in estate.", "Non gettare sigarette accese."],
                            "during": ["Chiamare immediatamente i soccorsi (112, 115) in caso di avvistamento di incendio.", "Seguire le indicazioni dei vigili del fuoco.", "Allontanarsi dalle aree interessate dal fumo."],
                            "after": ["Verificare danni a cose e persone.", "Attendere l'ok delle autorità per rientrare in aree evacuate."]
                        }
                    }
                },
                "aree_emergenza": [
                    { "tipologia": "Area di attesa", "nome": "Piazza Sant'Antonio", "ubicazione": "Piazza Sant'Antonio, Nova Siri", "lat": 40.1000, "lon": 16.5500, "note": "Punto di raccolta nel centro storico." }
                ],
                "punti_operativi": [], // nessun cancello specifico per Nova Siri per ora
                "contatti_emergenza": [
                    { "ruolo": "Sindaco", "nome": "Maria Neri", "contatto1": "0835536111", "contatto2": "" },
                    { "ruolo": "Ufficio Tecnico", "nome": "Luca Bianchi", "contatto1": "0835536222", "contatto2": "ufficiotecnico.novasiri@comune.it" }
                ],
                "procedure_operative": {
                    "rischioidrogeologico": {
                        "sindaco": ["Valutare la situazione e attivare il presidio del territorio.", "Emettere avvisi di cautela alla popolazione nelle aree a rischio.", "Organizzare squadre di monitoraggio per i versanti instabili."],
                        "ufficiotecnico": ["Effettuare sopralluoghi tecnici per valutare la stabilità dei terreni.", "Disporre eventuali interventi urgenti di messa in sicurezza."],
                        "protezionecivileregionale": ["Fornire supporto tecnico con geologi e mezzi speciali.", "Valutare la necessità di attivare piani di evacuazione regionali."],
                        "prefettura": ["Coordinare gli enti provinciali per la gestione dell'emergenza.", "Valutare la necessità di supporto extra-comunale."]
                    }
                },
                "alerts": [],
                "lastUpdated": "2025-06-16T13:35:00Z"
            },
            "matera": {
                "originalName": "Matera",
                "criticità": "A3", // Esempio: Arancione per Matera
                "rischi": {
                    "generale": "Matera è soggetta a rischio idrogeologico e sismico.",
                    "rischioidrogeologico": {
                        "alertStatus": "A3",
                        "alertMessage": "Rischio elevato di smottamenti e frane, specialmente nelle aree dei Sassi in caso di piogge intense.",
                        "guidelines": {
                            "before": ["Controllare lo stato delle abitazioni nei pressi di versanti e canali di scolo.", "Evitare modifiche non autorizzate del territorio che possano alterare il deflusso delle acque."],
                            "during": ["Non avvicinarsi a pendii instabili o corsi d'acqua in piena.", "In caso di smottamenti, allontanarsi immediatamente e avvisare le autorità (112, Protezione Civile).."],
                            "after": ["Attendere le verifiche geologiche e strutturali prima di rientrare in aree a rischio o in abitazioni danneggiate."]
                        }
                    }
                },
                "aree_emergenza": [
                    { "tipologia": "Punto di Raccolta Urbano", "nome": "Piazza Vittorio Veneto", "ubicazione": "Piazza Vittorio Veneto, Matera", "lat": 40.6658, "lon": 16.6074, "note": "Centro nevralgico per la raccolta e l'assistenza." }
                ],
                "punti_operativi": [],
                "contatti_emergenza": [
                    { "ruolo": "Sindaco Matera", "nome": "Domenico Bennardi", "contatto1": "0835241111", "contatto2": "sindaco@comune.mt.it" }
                ],
                "procedure_operative": {
                    "rischioidrogeologico": {
                        "sindaco": ["Attivare il COC e il piano di emergenza comunale.", "Disporre l'evacuazione preventiva delle aree a rischio frana.", "Coordinare gli interventi di soccorso e messa in sicurezza."],
                        "ufficiotecnico": ["Monitoraggio costante delle aree a rischio frana con droni e sensori.", "Disporre e supervisionare gli interventi urgenti di messa in sicurezza dei versanti.", "Valutare l'agibilità degli edifici post-evento."],
                        "vigilidelfuoco": ["Intervenire per soccorso a persone intrappolate o isolate da frane.", "Supportare le evacuazioni e allestimento aree di accoglienza."],
                        "carabinieri": ["Mantenere l'ordine pubblico nelle aree colpite e nei centri di accoglienza.", "Pattugliare le strade interrotte per impedire l'accesso."],
                        "prefettura": ["Attivare il CCS provinciale.", "Coordinare risorse e mezzi a livello provinciale.", "Dichiarare lo stato di calamità se necessario."]
                    }
                },
                "alerts": [
                    { "id": "alert_001_matera", "type": "Idrogeologico", "severity": "Elevata", "title": "Allerta Frane e Smottamenti", "description": "Si prevedono piogge intense, elevato rischio di smottamenti e frane nelle zone collinari e dei Sassi. Evitare spostamenti non essenziali.", "date": "2025-06-16T10:00:00Z" }
                ],
                "lastUpdated": "2025-06-16T13:40:00Z"
            },
            "potenza": {
                "originalName": "Potenza",
                "criticità": "A2",
                "rischi": {
                    "generale": "Potenza è esposta principalmente a rischio sismico e idrogeologico.",
                    "rischio sismico": {
                        "alertStatus": "A2",
                        "alertMessage": "Area a media sismicità. Prestare attenzione alle strutture e prepararsi a comportamenti adeguati.",
                        "guidelines": {
                            "before": ["Verificare l'integrità strutturale degli edifici e consultare un tecnico se ci sono dubbi.", "Preparare un kit di emergenza con acqua, cibo, medicine e torcia.", "Avere un piano di emergenza familiare e punti di ritrovo."],
                            "during": ["Cercare riparo sotto tavoli robusti o in vani delle porte se all'interno.", "Allontanarsi da finestre, mobili alti e oggetti che possono cadere.", "Se all'aperto, allontanarsi da edifici, alberi, lampioni e linee elettriche."],
                            "after": ["Controllare la propria sicurezza e quella dei familiari.", "Interrompere gas ed elettricità se possibile e sicuro.", "Non usare ascensori.", "Recarsi ai punti di raccolta designati se necessario."]
                        }
                    }
                },
                "aree_emergenza": [
                    { "tipologia": "Centro di accoglienza", "nome": "Palazzetto dello Sport", "ubicazione": "Via Campania, Potenza", "lat": 40.6400, "lon": 15.8000, "note": "Struttura coperta per accoglienza massiva." }
                ],
                "punti_operativi": [],
                "contatti_emergenza": [
                    { "ruolo": "Comune di Potenza", "nome": "Ufficio Protezione Civile", "contatto1": "0971415111", "contatto2": "protcivile@comune.potenza.it" }
                ],
                "procedure_operative": {
                    "rischio sismico": {
                        "comunepotenza": ["Attivare immediatamente il COC e diramare le prime informazioni alla popolazione.", "Organizzare squadre di valutazione danni sugli edifici pubblici e privati.", "Predisporre i punti di assistenza e triage sanitario."],
                        "vigilidelfuoco": ["Ricerca e soccorso di persone sotto le macerie.", "Messa in sicurezza di edifici crollati o pericolanti.", "Interventi per fughe di gas o incendi post-sisma."],
                        "carabinieri": ["Garantire l'ordine e la sicurezza pubblica nelle aree colpite e nei centri di accoglienza.", "Supportare le evacuazioni e il blocco delle aree inagibili."],
                        "protezionecivileregionale": ["Coordinare l'invio di colonne mobili e risorse da altre province/regioni.", "Allestire campi base e strutture di accoglienza di media/lunga durata."],
                        "prefettura": ["Attivare il CCS provinciale.", "Richiedere l'intervento dell'Esercito in caso di necessità.", "Coordinare la distribuzione degli aiuti umanitari."]
                    }
                },
                "alerts": [],
                "lastUpdated": "2025-06-16T13:45:00Z"
            }
        };

        // Function to display sections based on role
        function updateVisibility(role) {
            const infoCards = document.querySelectorAll('.info-card');
            infoCards.forEach(card => {
                const rolesData = card.getAttribute('data-roles');
                if (rolesData) {
                    const allowedRoles = rolesData.split(',').map(r => r.trim());
                    if (allowedRoles.includes(role)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });

            // Update active button
            document.querySelectorAll('.role-selector button').forEach(button => {
                if (button.dataset.role === role) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

             // Re-initialize map to fix potential rendering issues if it was hidden
            if (map) {
                map.invalidateSize();
            }
        }

        // Function to load and display data for the selected comune
        async function loadComuneData(roleFromUrl = null) {
            const comuneParam = getParameterByName('comune');
            if (!comuneParam) {
                comuneNameElement.textContent = "Errore: Nome comune non specificato nell'URL.";
                return;
            }

            // Determine the role: from URL first, then localStorage, then default
            currentRole = roleFromUrl || localStorage.getItem('selectedRole') || 'cittadino';
            localStorage.setItem('selectedRole', currentRole); // Save to localStorage

            // Update visibility based on the determined role
            updateVisibility(currentRole);

            const normalizedComuneName = normalizeComuneName(comuneParam);
            let originalComuneName = comuneParam; // Default to URL input

            try {
                const response = await fetch('basilicata/limits_R_17_municipalities.geojson');
                const geojsonData = await response.json();
                const foundFeature = geojsonData.features.find(f => normalizeComuneName(f.properties.name) === normalizedComuneName);
                if (foundFeature) {
                    originalComuneName = foundFeature.properties.name;
                }
            } catch (error) {
                console.warn("Impossibile caricare GeoJSON o trovare nome comune originale:", error);
            }

            comuneNameElement.textContent = `Bollettino del Comune di ${originalComuneName}`;
            alertComuneNamePlaceholder.textContent = originalComuneName; // Update alert placeholder

            const comuneData = dummyComuniData[normalizedComuneName];

            if (comuneData) {
                // --- Criticity ---
                const criticityCode = comuneData.criticità || 'N/D';
                criticityDisplay.textContent = criticityCode;
                const criticityColorClass = getCriticityColorClass(criticityCode);
                criticityDisplay.className = `criticity-box ${criticityColorClass}`; // Apply class for styling
                criticityDescription.textContent = `Lo stato attuale del comune è ${getColorDescription(criticityCode)}`;

                // --- Risk Information ---
                if (comuneData.rischi && Object.keys(comuneData.rischi).length > 0) {
                    noRisksMessage.style.display = 'none';
                    rischioGeneraleDisplay.textContent = comuneData.rischi.generale || 'Nessuna descrizione generale dei rischi.';
                    rischiSpecificiList.innerHTML = ''; // Clear previous content

                    for (const riskKey in comuneData.rischi) {
                        if (riskKey === 'generale') continue; // Skip general description

                        const riskDetails = comuneData.rischi[riskKey];
                        const riskDisplayName = getRiskDisplayNameFromNormalized(riskKey);
                        const riskItem = document.createElement('div');
                        riskItem.className = 'risk-item';
                        riskItem.innerHTML = `
                            <strong>${riskDisplayName}:</strong>
                            <p>Stato: <span class="font-semibold text-${riskDetails.alertStatus.toLowerCase().replace('a','')}-700 criticity-box ${getCriticityColorClass(riskDetails.alertStatus)}">${globalColors[riskDetails.alertStatus].label || riskDetails.alertStatus}</span></p>
                            <p>${riskDetails.alertMessage}</p>
                            ${riskDetails.guidelines ? `
                                <div class="risk-guidelines">
                                    <h4>Linee Guida per i Cittadini:</h4>
                                    ${riskDetails.guidelines.before && riskDetails.guidelines.before.length > 0 ? `<div class="mb-2"><strong>Prima:</strong><ul class="list-disc ml-4">${riskDetails.guidelines.before.map(g => `<li>${g}</li>`).join('')}</ul></div>` : ''}
                                    ${riskDetails.guidelines.during && riskDetails.guidelines.during.length > 0 ? `<div class="mb-2"><strong>Durante:</strong><ul class="list-disc ml-4">${riskDetails.guidelines.during.map(g => `<li>${g}</li>`).join('')}</ul></div>` : ''}
                                    ${riskDetails.guidelines.after && riskDetails.guidelines.after.length > 0 ? `<div class="mb-2"><strong>Dopo:</strong><ul class="list-disc ml-4">${riskDetails.guidelines.after.map(g => `<li>${g}</li>`).join('')}</ul></div>` : ''}
                                </div>
                            ` : ''}
                        `;
                        rischiSpecificiList.appendChild(riskItem);
                    }
                } else {
                    noRisksMessage.style.display = 'block';
                    rischioGeneraleDisplay.textContent = ''; // Clear if no risks
                }

                // --- Emergency Areas / Operational Points (combined for display and map) ---
                const allMapPoints = [];
                if (comuneData.aree_emergenza) {
                    allMapPoints.push(...comuneData.aree_emergenza.map(p => ({...p, type: 'area'})));
                }
                // Always include gate locations in the list and on the map if role is comune or ente
                if (comuneData.punti_operativi && (currentRole === 'comune' || currentRole === 'ente')) {
                    allMapPoints.push(...comuneData.punti_operativi.map(p => ({...p, type: 'gate'})));
                    mapPointsIntroText.textContent = "Di seguito le aree di emergenza e i punti operativi (cancelli rossi/arancioni) sul territorio comunale.";
                } else {
                    mapPointsIntroText.textContent = "Di seguito le aree di emergenza (punti di raccolta, assistenza) sul territorio comunale.";
                }

                if (allMapPoints.length > 0) {
                    noPuntiMappaMessage.style.display = 'none';
                    puntiMappaDisplay.innerHTML = '';
                    const markers = [];
                    let firstPointCoords = [0,0]; // Fallback for map center

                    allMapPoints.forEach((punto, index) => {
                        // Display list items based on role (gates only for comune/ente)
                        let displayInList = false;
                        let itemClass = '';
                        if (punto.type === 'area') {
                            displayInList = true;
                        } else if (punto.type === 'gate' && (currentRole === 'comune' || currentRole === 'ente')) {
                            displayInList = true;
                            itemClass = punto.livello_allerta ? `gate-${punto.livello_allerta.toLowerCase()}` : 'operative-point';
                        }

                        if (displayInList) {
                            const puntoItem = document.createElement('div');
                            puntoItem.className = `punto-mappa-item ${itemClass}`;
                            puntoItem.innerHTML = `
                                <span class="punto-type">${punto.tipologia}</span>
                                <p class="punto-name">${punto.nome}</p>
                                <p class="punto-address"><i class="fas fa-map-pin mr-1"></i>${punto.ubicazione}</p>
                                <p class="punto-coords">Lat: ${punto.lat}, Lon: ${punto.lon}</p>
                                ${punto.note ? `<p class="punto-notes"><i class="fas fa-sticky-note mr-1"></i>${punto.note}</p>` : ''}
                            `;
                            puntiMappaDisplay.appendChild(puntoItem);
                        }

                        if (punto.lat && punto.lon) {
                            if (index === 0) firstPointCoords = [punto.lat, punto.lon]; // Set first point for initial view

                            let markerIcon;
                            if (punto.type === 'gate' && (currentRole === 'comune' || currentRole === 'ente')) {
                                // Custom icon for operational points (e.g., red pin for cancelli)
                                let iconColorClass = '';
                                if (punto.livello_allerta && punto.livello_allerta.toLowerCase().includes('rosso')) {
                                    iconColorClass = 'red';
                                } else if (punto.livello_allerta && punto.livello_allerta.toLowerCase().includes('arancione')) {
                                    iconColorClass = 'orange';
                                }

                                markerIcon = L.divIcon({
                                    className: `leaflet-div-icon custom-gate-icon ${iconColorClass}`,
                                    html: '<i class="fas fa-ban"></i>', // Ban symbol for gates
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 15],
                                    popupAnchor: [0, -15]
                                });
                            } else if (punto.type === 'area') {
                                // Default green marker for emergency areas
                                markerIcon = L.divIcon({
                                    className: 'leaflet-div-icon custom-area-icon',
                                    html: '<i class="fas fa-hospital"></i>', // Hospital/shelter symbol for areas
                                    iconSize: [25, 25],
                                    iconAnchor: [12, 12],
                                    popupAnchor: [0, -12]
                                });
                            } else {
                                // Skip adding marker if it's a gate and role is cittadino
                                return;
                            }


                            const marker = L.marker([punto.lat, punto.lon], { icon: markerIcon })
                                .bindPopup(`<strong>${punto.nome}</strong><br>${punto.ubicazione}<br>${punto.tipologia}${punto.note ? `<br><em>${punto.note}</em>` : ''}`);
                            markers.push(marker);
                        }
                    });

                    // Initialize/update map
                    if (!map) {
                        map = L.map('map').setView(firstPointCoords, 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);
                    } else {
                        map.eachLayer(layer => {
                            if (layer instanceof L.Marker) {
                                map.removeLayer(layer);
                            }
                        });
                        map.setView(firstPointCoords, map.getZoom()); // Keep current zoom or set default
                    }

                    // Add all markers to the map
                    markers.forEach(marker => marker.addTo(map));
                    if (markers.length > 0) {
                        const featureGroup = L.featureGroup(markers);
                        map.fitBounds(featureGroup.getBounds().pad(0.2)); // Add padding so markers aren't on the edge
                        map.setZoom(Math.min(map.getZoom(), 14)); // Max zoom to avoid being too close
                    }


                } else {
                    noPuntiMappaMessage.style.display = 'block';
                    // Optionally hide map or show a message on it if no points
                    if (map) {
                        map.remove(); // Remove map instance if no points
                        map = null;
                        document.getElementById('map').innerHTML = '<p class="no-data">Mappa non disponibile senza punti di interesse.</p>';
                    }
                }

                // --- Emergency Contacts ---
                if (comuneData.contatti_emergenza && comuneData.contatti_emergenza.length > 0) {
                    noContattiMessage.style.display = 'none';
                    contattiEmergenzaDisplay.innerHTML = '';
                    comuneData.contatti_emergenza.forEach(contact => {
                        const contactItem = document.createElement('div');
                        contactItem.className = 'contact-item';
                        contactItem.innerHTML = `
                            <strong>${contact.ruolo}:</strong> ${contact.nome ? contact.nome : ''}
                            ${contact.contatto1 ? `<p>Contatto Principale: <a href="tel:${contact.contatto1}" class="text-blue-600 hover:underline">${contact.contatto1}</a></p>` : ''}
                            ${contact.contatto2 ? `<p>Contatto Alternativo: <a href="mailto:${contact.contatto2}" class="text-blue-600 hover:underline">${contact.contatto2}</a></p>` : ''}
                        `;
                        contattiEmergenzaDisplay.appendChild(contactItem);
                    });
                } else {
                    noContattiMessage.style.display = 'block';
                }

                // --- Operational Procedures ---
                if (comuneData.procedure_operative && Object.keys(comuneData.procedure_operative).length > 0) {
                    noProcedureMessage.style.display = 'none';
                    procedureOperativeDisplay.innerHTML = '';
                    for (const riskKey in comuneData.procedure_operative) {
                        const riskDisplayName = getRiskDisplayNameFromNormalized(riskKey);
                        const procedureRiskSection = document.createElement('div');
                        procedureRiskSection.className = 'procedure-risk-section';
                        procedureRiskSection.innerHTML = `<h3><i class="fas fa-tasks"></i> Procedure per ${riskDisplayName}</h3>`;

                        const proceduresForRisk = comuneData.procedure_operative[riskKey];
                        // Sort entities for consistent display (e.g., Sindaco, Polizia Locale, Carabinieri, etc.)
                        const sortedEntityKeys = Object.keys(proceduresForRisk).sort((a, b) => {
                            const order = ["sindaco", "coc", "prefettura", "polizialocale", "carabinieri", "vigilidelfuoco", "capitaneriadiporto", "ufficiotecnico", "protezionecivileregionale"]; // Aggiornato l'ordine con "prefettura"
                            const indexA = order.indexOf(normalizeEntityName(a));
                            const indexB = order.indexOf(normalizeEntityName(b));
                            if (indexA === -1 && indexB === -1) return a.localeCompare(b); // If both not in order, sort alphabetically
                            if (indexA === -1) return 1; // Put non-ordered at end
                            if (indexB === -1) return -1; // Put non-ordered at end
                            return indexA - indexB;
                        });

                        sortedEntityKeys.forEach(entityKey => {
                            const entityDisplayName = entityKey
                                .replace(/([A-Z])/g, ' $1') // Add space before capital letters
                                .replace('coc', 'Centro Operativo Comunale (COC)')
                                .replace('ufficiotecnico', 'Ufficio Tecnico')
                                .replace('vigilidelfuoco', 'Vigili del Fuoco')
                                .replace('polizialocale', 'Polizia Locale')
                                .replace('carabinieri', 'Carabinieri')
                                .replace('capitaneriadiporto', 'Capitaneria di Porto')
                                .replace('protezionecivileregionale', 'Protezione Civile Regionale')
                                .replace('prefettura', 'Prefettura') // Aggiunto display name per Prefettura
                                .split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize first letter of each word
                                .join(' ');

                            const procedureItem = document.createElement('div');
                            procedureItem.className = 'procedure-entity-item';
                            procedureItem.innerHTML = `
                                <strong>${entityDisplayName}:</strong>
                                <ul>
                                    ${proceduresForRisk[entityKey].map(proc => `<li>${proc}</li>`).join('')}
                                </ul>
                            `;
                            procedureRiskSection.appendChild(procedureItem);
                        });
                        procedureOperativeDisplay.appendChild(procedureRiskSection);
                    }
                } else {
                    noProcedureMessage.style.display = 'block';
                }

                // --- Alerts (New/Improved) ---
                if (comuneData.alerts && comuneData.alerts.length > 0) {
                    noAlertsMessage.style.display = 'none';
                    alertsList.innerHTML = ''; // Clear initial message
                    comuneData.alerts.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first

                    comuneData.alerts.forEach(alert => {
                        let iconClass = 'fas fa-info-circle';
                        let alertClass = 'info'; // Default
                        if (alert.severity) {
                            switch (alert.severity.toLowerCase()) {
                                case 'moderata':
                                    iconClass = 'fas fa-exclamation-triangle';
                                    alertClass = 'warning';
                                    break;
                                case 'elevata':
                                case 'grave':
                                    iconClass = 'fas fa-exclamation-circle';
                                    alertClass = 'danger';
                                    break;
                                case 'bassa':
                                case 'ordinaria':
                                    iconClass = 'fas fa-info-circle';
                                    alertClass = 'info';
                                    break;
                            }
                        }

                        const alertItem = document.createElement('div');
                        alertItem.className = `alert-item ${alertClass}`;
                        alertItem.innerHTML = `
                            <i class="${iconClass}"></i>
                            <div>
                                <strong>${alert.title || 'Allerta Senza Titolo'} (${alert.type || 'Generico'})</strong>
                                <p>${alert.description || 'Nessuna descrizione.'}</p>
                                <p class="text-xs text-gray-700 mt-1">Data: ${new Date(alert.date).toLocaleString('it-IT')}</p>
                            </div>
                        `;
                        alertsList.appendChild(alertItem);
                    });
                } else {
                    noAlertsMessage.style.display = 'block';
                    // Keep the default "Nessuna Allerta Attiva" message if no alerts
                    alertsList.innerHTML = `
                        <div class="alert-item info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Nessuna Allerta Attiva:</strong>
                                <p>Non ci sono allerte attive al momento per il comune di <span id="alert-comune-name-placeholder">${originalComuneName}</span>. Controllare regolarmente per aggiornamenti.</p>
                            </div>
                        </div>
                    `;
                }

                // --- Last Updated Timestamp ---
                if (comuneData.lastUpdated) {
                    lastUpdatedElement.textContent = new Date(comuneData.lastUpdated).toLocaleString('it-IT');
                } else {
                    lastUpdatedElement.textContent = 'Non disponibile';
                }

            } else {
                comuneNameElement.textContent = `Dati non trovati per il Comune di ${originalComuneName}`;
                document.querySelector('.container').innerHTML += `<p class="no-data">Siamo spiacenti, i dati per questo comune non sono ancora disponibili o non esistono.</p>`;
                // Hide all other sections if no data
                document.querySelectorAll('.info-card').forEach(card => card.style.display = 'none');
                document.getElementById('map').style.display = 'none'; // Ensure map is also hidden
                lastUpdatedElement.textContent = 'N/D';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const roleParam = getParameterByName('role');
            loadComuneData(roleParam); // Load data and set initial visibility

            // Add event listeners for role selection buttons
            document.querySelectorAll('.role-selector button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const selectedRole = event.target.dataset.role;
                    const comuneParam = getParameterByName('comune');
                    // Reload the page with the new role parameter to ensure map re-render and clean state
                    window.location.href = `comunecosta.html?comune=${comuneParam}&role=${selectedRole}`;
                });
            });
        });
    </script>
</body>

</html>
